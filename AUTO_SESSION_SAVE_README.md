# 자동 세션 저장 및 불러오기 기능

## 개요

글 작성이 완료되면 자동으로 세션이 저장되어 작성 내역에 기록됩니다. 사용자는 작성 내역 페이지에서 불러오기 버튼을 통해 해당 글의 작성 환경과 챗봇 대화 내역을 복원하여 수정할 수 있습니다.

## 주요 변경사항

### 1. 서버 측 자동 세션 저장 (server/routes.ts)

#### 글 생성 완료 시 자동 저장
- **위치**: `/api/projects/:id/generate` 엔드포인트
- **동작**: 글 생성이 완료되면 자동으로 프로젝트 세션을 생성
- **저장 내용**:
  - 키워드 및 키워드 분석
  - 소제목 및 리서치 데이터
  - 비즈니스 정보
  - 생성된 콘텐츠 및 SEO 메트릭
  - 참조 링크 및 이미지
  - **챗봇 대화 내역**
  - 커스텀 형태소

#### 재생성 시 자동 저장
- **위치**: `/api/projects/:id/regenerate` 엔드포인트
- **동작**: 콘텐츠 재생성 완료 시에도 자동으로 세션 저장
- **설명**: "재생성 후 자동 저장된 글"로 표시

### 2. 클라이언트 측 불러오기 기능 (client/src/pages/history.tsx)

#### 세션 매칭 로직
- 각 완성된 글에 대해 동일한 키워드를 가진 세션을 검색
- 생성 시간이 5분 이내로 가까운 세션을 매칭 (자동 저장된 세션)
- 매칭된 세션이 있으면 "불러오기" 버튼 표시

#### 불러오기 버튼
- **아이콘**: 📂 FolderOpen
- **위치**: 각 완성된 글 카드의 우측 상단
- **동작**: 
  1. 세션 데이터를 새 프로젝트로 로드
  2. 챗봇 대화 내역 복원
  3. 프로젝트 페이지로 이동
  4. 챗봇으로 바로 수정 가능

## 사용 흐름

### 1. 글 작성 및 자동 저장
```
사용자: 키워드 입력 및 콘텐츠 생성
     ↓
시스템: 글 생성 완료
     ↓
시스템: 자동으로 세션 저장 ✅
     ↓
시스템: 작성 내역에도 기록
```

### 2. 작성 내역에서 불러오기
```
사용자: 작성 내역 페이지 접속
     ↓
사용자: 수정하고 싶은 글의 "불러오기" 버튼 클릭
     ↓
시스템: 해당 글의 세션 로드
     ↓
시스템: 새 프로젝트 생성 및 챗봇 대화 내역 복원
     ↓
사용자: 챗봇으로 글 수정 시작 ✨
```

### 3. 챗봇으로 수정
```
사용자: "두 번째 단락을 더 자세히 설명해줘"
     ↓
챗봇: 이전 대화 내역을 참고하여 수정
     ↓
시스템: 수정된 내용 반영
     ↓
사용자: 계속 수정하거나 완료
```

## 기술적 세부사항

### 자동 저장 시점
- `generateStrictMorphemeContent()` 완료 후
- `regenerateWithStrictMorphemes()` 완료 후
- 작성 내역 저장과 동시에 실행

### 세션 이름 형식
```
{키워드} - {년도-월-일 시:분}
예: "블로그 SEO 최적화 - 2025-01-22 14:30"
```

### 저장 실패 처리
- 세션 저장 실패 시에도 메인 프로세스는 계속 진행
- 에러는 콘솔에 로그만 기록
- 사용자에게는 영향 없음

### 챗봇 대화 복원
- 세션의 `chatHistory` 필드에서 모든 대화 로드
- 새 프로젝트의 `chat_messages` 테이블에 복사
- `EditingChat` 컴포넌트가 자동으로 표시

## 데이터베이스 스키마

### project_sessions 테이블
```sql
CREATE TABLE project_sessions (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL,
  project_id INTEGER,
  session_name TEXT NOT NULL,
  session_description TEXT,
  keyword TEXT NOT NULL,
  keyword_analysis JSONB,
  subtitles JSONB,
  research_data JSONB,
  business_info JSONB,
  generated_content TEXT,
  seo_metrics JSONB,
  reference_links JSONB,
  generated_images JSONB,
  reference_blog_links JSONB,
  custom_morphemes TEXT,
  chat_history JSONB,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

## API 엔드포인트

### POST `/api/projects/:id/generate`
- 콘텐츠 생성 및 자동 세션 저장

### POST `/api/projects/:id/regenerate`
- 콘텐츠 재생성 및 자동 세션 저장

### GET `/api/sessions`
- 사용자의 모든 세션 조회

### POST `/api/sessions/:sessionId/load`
- 세션을 새 프로젝트로 불러오기
- 챗봇 대화 내역 복원

### GET `/api/completed-projects`
- 작성 내역 조회

## 사용자 이점

### 1. 자동 백업
- 글 작성 완료 시 자동으로 백업
- 실수로 삭제해도 복구 가능

### 2. 버전 관리
- 같은 키워드로 여러 버전 작성 가능
- 이전 버전 불러와서 비교 가능

### 3. 연속 작업
- 이전 대화 맥락 유지
- 챗봇이 이전 지시사항 기억
- 자연스러운 수정 작업

### 4. 시리즈 글 작성
- 이전 글 불러와서 스타일 유지
- 일관된 톤으로 시리즈 작성

## 예시 시나리오

### 시나리오 1: A/B 테스트
```
1. "블로그 SEO 최적화" 키워드로 글 작성
   → 자동 저장 ✅
2. 작성 내역에서 불러오기
3. 챗봇: "더 캐주얼한 톤으로 바꿔줘"
4. 새로운 버전 완성
   → 자동 저장 ✅
5. 두 버전 비교 후 선택
```

### 시나리오 2: 점진적 개선
```
1. 초안 작성 완료
   → 자동 저장 ✅
2. 다음날 작성 내역에서 불러오기
3. 챗봇: "전문 용어 더 추가해줘"
4. 개선된 버전 완료
   → 자동 저장 ✅
5. 반복적으로 개선
```

### 시나리오 3: 실수 복구
```
1. 글 작성 완료
   → 자동 저장 ✅
2. 수정하다가 실수로 망침
3. 작성 내역에서 이전 버전 불러오기
4. 다시 시작 ✨
```

## 주의사항

1. **세션 저장 용량**: 
   - 각 세션은 전체 프로젝트 스냅샷 저장
   - 많은 이미지나 긴 대화는 용량 차지

2. **매칭 시간 제한**: 
   - 5분 이내 생성된 세션만 자동 매칭
   - 수동 저장 세션은 별도 관리 필요

3. **챗봇 대화 복원**:
   - 모든 이전 대화 내역 복원
   - 컨텍스트가 길어질 수 있음

## 향후 개선사항

- [ ] 세션 자동 정리 (오래된 세션 삭제)
- [ ] 세션 태그 및 메모 기능
- [ ] 세션 비교 UI
- [ ] 세션 병합 기능
- [ ] 자동 저장 on/off 설정

## 트러블슈팅

### 불러오기 버튼이 보이지 않음
- 해당 글의 자동 저장 세션이 없을 수 있음
- 생성 시간 차이가 5분 이상일 수 있음
- 세션 목록에서 수동으로 찾아보기

### 챗봇 대화가 복원되지 않음
- 세션 저장 시 챗봇 대화가 없었을 수 있음
- 데이터베이스 연결 확인

### 세션 로드 실패
- 권한 확인 (다른 사용자 세션)
- 데이터베이스 마이그레이션 확인
- 서버 로그 확인

## 테스트 체크리스트

- [ ] 글 생성 완료 시 세션 자동 저장 확인
- [ ] 작성 내역 페이지에서 불러오기 버튼 표시 확인
- [ ] 세션 불러오기 후 프로젝트 생성 확인
- [ ] 챗봇 대화 내역 복원 확인
- [ ] 챗봇으로 수정 기능 동작 확인
- [ ] 재생성 시 세션 저장 확인
- [ ] 여러 버전 관리 확인
